generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
  engineType    = "binary"
}

datasource db {
  provider = "postgresql"
}

enum BoxState {
  OK
  LOW
  EMPTY
}

enum Unit {
  g
  ml
}

enum OtpPurpose {
  LOGIN
}

enum OtpChannel {
  SMS
  WHATSAPP
}

enum OtpStatus {
  PENDING
  VERIFIED
  EXPIRED
  LOCKED
}

enum HouseholdRole {
  OWNER
  ADMIN
  MEMBER
}

enum ShoppingUnit {
  PCS // יח'
  G
  KG
  ML
  L
}

enum MemberStatus {
  ACTIVE
  INVITED
  REMOVED
}

model Box {
  id       String @id @db.Uuid
  code     String @unique
  deviceId String @unique

  name     String
  unit     Unit
  capacity Float?

  fullQuantity Float?
  quantity     Float    @default(0)
  percent      Float    @default(0)
  state        BoxState @default(EMPTY)

  lastReadingAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  telemetry TelemetryEvent[]

  householdId String
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
}

model TelemetryEvent {
  id String @id @default(uuid()) @db.Uuid

  boxId String @db.Uuid
  box   Box    @relation(fields: [boxId], references: [id], onDelete: Cascade)

  quantity  Float
  percent   Float
  state     BoxState
  timestamp DateTime

  createdAt DateTime @default(now())

  @@index([boxId, timestamp])
}

model User {
  id String @id @default(uuid())

  // ✅ was required, now optional (כי Google login בלי טלפון)
  phoneE164 String? @unique

  // ✅ NEW: Google user id (sub)
  googleSub String? @unique
  email     String? // לא חייב unique (אבל אפשר אם בא לך)

  displayName       String?
  avatarUrl         String?
  activeHouseholdId String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  isAdmin           Boolean   @default(false)

  sessions    AuthSession[]
  memberships HouseholdMember[]

  trust            UserTrust?
  shoppingDefaults Json?
  termDefaults     TermUserDefaults[] // ✅ OK

  @@index([activeHouseholdId])
}

model OtpChallenge {
  id        String     @id @default(uuid())
  phoneE164 String
  purpose   OtpPurpose
  channel   OtpChannel
  codeHash  String
  expiresAt DateTime
  attempts  Int        @default(0)
  sentCount Int        @default(1)
  status    OtpStatus  @default(PENDING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([phoneE164, status, createdAt])
}

model AuthSession {
  id               String    @id @default(uuid())
  userId           String
  refreshTokenHash String
  deviceName       String?
  createdAt        DateTime  @default(now())
  lastUsedAt       DateTime  @default(now())
  revokedAt        DateTime?
  expiresAt DateTime


  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
}

model Household {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boxes   Box[]
  members HouseholdMember[]

  // ✅ NEW: shopping lists
  shoppingLists    ShoppingList[]
  shoppingSettings ShoppingSettings?
}

model HouseholdMember {
  id          String        @id @default(uuid())
  householdId String
  userId      String
  role        HouseholdRole @default(MEMBER)
  status      MemberStatus  @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
  @@index([userId])
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique // לדוגמה "catalog"
  json      Json
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

/**
 * =========================
 * TERMS (Autocomplete)
 * =========================
 * שינוי מרכזי:
 * - הוספנו LIVE כדי ש-Term חדש יופיע לכולם כדי לדרג.
 * - אם נדחה => עובר ל-RejectedTerm ונמחק מהגלובלי.
 * - PENDING נשאר למקרים של resubmit / משתמש חשוד (בשרת נחליט).
 */

enum TermStatus {
  LIVE
  PENDING
  APPROVED
  REJECTED
}

enum TermScope {
  GLOBAL
  PRIVATE
}

enum VoteValue {
  UP
  DOWN
}

model TermUserDefaults {
  userId   String
  termId   String

  category ShoppingCategory?
  unit     ShoppingUnit?
  qty      Float?
  extras   Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  term Term @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@id([userId, termId])                 // ✅ זה מייצר where unique בשם userId_termId
  @@index([termId])
}

model Term {
  id          String     @id @default(uuid())
  scope       TermScope  @default(GLOBAL)
  ownerUserId String? // אם PRIVATE
  status      TermStatus @default(LIVE)
  imageUrl String? // ✅

  // legacy flags (השארתי כדי לא לשבור קוד קיים)
  approvedByAdmin Boolean   @default(false)
  approvedAt      DateTime?

  // ✅ NEW: defaults for shopping
  defaultCategory ShoppingCategory?
  defaultUnit     ShoppingUnit?
  defaultQty      Float?
  defaultExtras   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  translations TermTranslation[]
  votes        TermVote[]
  userDefaults TermUserDefaults[] // ✅ ADD THIS

  @@index([status])
  @@index([scope, ownerUserId])
}

model TermTranslation {
  id         String @id @default(uuid())
  termId     String
  lang       String // "he" | "en" ...
  text       String
  normalized String // lower/trim
  source     String // "USER" | "AUTO" | "ADMIN"

  createdAt DateTime @default(now())

  term Term @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([termId, lang])
  @@index([lang, normalized])
}

model TermVote {
  id        String    @id @default(uuid())
  termId    String
  userId    String
  vote      VoteValue
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  term Term @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([termId, userId])
  @@index([termId])
  @@index([userId])
}

/**
 * ✅ NEW: Rejected terms table (לא בגלובלי)
 * נשמר לצורכי:
 * - ממשק ניהול (לראות הכל + סיבה)
 * - להציג ליוצר הודעת "לא אושר" + הערת אדמין (אם יש)
 * שומרים snapshot כדי שלא תלוי במבנה של Term בעתיד.
 */
model RejectedTerm {
  id String @id @default(uuid())

  // מי יצר
  createdByUserId   String
  // מי דחה (אופציונלי)
  rejectedByAdminId String?
  // הערה שמוצגת למשתמש רק אם קיימת
  rejectReason      String?

  // snapshot of the "term" at rejection time:
  // { term: {...}, translations: [...], votes: [...], counts: {...} }
  snapshot Json

  rejectedAt DateTime @default(now())

  @@index([createdByUserId, rejectedAt])
}

/**
 * ✅ NEW: Trust flags for users (חשוד/לא חשוד)
 * אם termsRequireApproval=true => בשרת תיצור Term חדש כ-PENDING במקום LIVE.
 * אדמין יכול להחזיר ל-false.
 */
model UserTrust {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  termsRequireApproval Boolean @default(false)
  trustScore           Int     @default(100)

  flaggedAt  DateTime?
  flagReason String?

  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * SHOPPING LISTS
 * =========================
 * - Household-based
 * - settings global + override per list
 * - items with extra Json to add fields later בלי לשבור UI
 */

model ShoppingList {
  id          String    @id @default(uuid())
  householdId String
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  name String

  // settings override per list (filters/sort/group etc)
  settingsOverride Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ShoppingItem[]

  @@index([householdId, updatedAt])
}

enum ShoppingCategory {
  VEGETABLES
  FRUITS
  DAIRY
  MEAT_FISH
  BAKERY
  PANTRY
  FROZEN
  DRINKS
  SNACKS
  SPICES
  CLEANING
  BABY
  PHARM
  OTHER
}

model ShoppingItem {
  id String @id @default(uuid())

  listId String
  list   ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)

  // ✅ מקור מהמילון (אופציונלי)
  termId String? @db.Uuid

  text           String
  normalizedText String?
  dedupeKey      String // ✅ חדש

  qty     Float
  unit    ShoppingUnit
  checked Boolean      @default(false)

  imageUrl String?
  category ShoppingCategory?
  extra    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([listId, dedupeKey]) // ✅ מונע כפילויות תמיד
  @@index([listId, checked])
  @@index([listId, updatedAt])
  @@index([termId])
}

model ShoppingSettings {
  id          String    @id @default(uuid())
  householdId String    @unique
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  // default view settings for all lists
  defaultView Json

  updatedAt DateTime @updatedAt
}

model AdminAuditLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String // "CONFIG_PATCH" | "TERM_APPROVE" | "TERM_REJECT" וכו'
  targetId  String? // termId וכו'
  before    Json?
  after     Json?
  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([action])
}
